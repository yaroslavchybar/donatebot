{
  "version": 3,
  "sources": ["../../../../src/cli/lib/checkForLargeIndexDeletion.ts"],
  "sourcesContent": ["import { chalkStderr } from \"chalk\";\nimport { Context } from \"../../bundler/context.js\";\nimport {\n  changeSpinner,\n  logFinishedStep,\n  logMessage,\n  stopSpinner,\n} from \"../../bundler/log.js\";\nimport { formatIndex } from \"./indexes.js\";\nimport { promptYesNo } from \"./utils/prompts.js\";\nimport { Span } from \"./tracing.js\";\nimport { StartPushRequest } from \"./deployApi/startPush.js\";\nimport { evaluatePush } from \"./deploy2.js\";\nimport { DeveloperIndexConfig, IndexDiff } from \"./deployApi/finishPush.js\";\nimport { runSystemQuery } from \"./run.js\";\n\nconst MIN_DOCUMENTS_FOR_INDEX_DELETE_WARNING = 100_000;\n\nexport async function checkForLargeIndexDeletion({\n  ctx,\n  span,\n  request,\n  options,\n  askForConfirmation,\n}: {\n  ctx: Context;\n  span: Span;\n  request: StartPushRequest;\n  options: {\n    url: string;\n    deploymentName: string | null;\n    adminKey: string;\n  };\n  askForConfirmation: boolean;\n}): Promise<void> {\n  changeSpinner(\"Verifying that the push isn\u2019t deleting large indexes...\");\n\n  const { schemaChange } = await evaluatePush(ctx, span, request, options);\n\n  const indexDiffs = schemaChange.indexDiffs ?? {};\n  const deletedIndexes = Object.entries(indexDiffs).flatMap(\n    ([componentDefinitionPath, indexDiff]) =>\n      indexDiff.removed_indexes.map((index) => ({\n        componentDefinitionPath,\n        index,\n      })),\n  );\n\n  if (deletedIndexes.length === 0) {\n    logFinishedStep(\"No indexes are deleted by this push\");\n    return;\n  }\n\n  const tablesWithDeletedIndexes = [\n    ...new Set(\n      deletedIndexes.map(\n        ({ componentDefinitionPath, index }) =>\n          `${componentDefinitionPath}:${getTableName(index)}`,\n      ),\n    ),\n  ].map((str) => {\n    const [componentDefinitionPath, table] = str.split(\":\");\n    return { componentDefinitionPath, table };\n  });\n  changeSpinner(\"Checking whether the deleted indexes are on large tables...\");\n  const documentCounts = await Promise.all(\n    tablesWithDeletedIndexes.map(\n      async ({ componentDefinitionPath, table }) => ({\n        componentDefinitionPath,\n        table,\n        count: (await runSystemQuery(ctx, {\n          deploymentUrl: options.url,\n          adminKey: options.adminKey,\n          functionName: \"_system/cli/tableSize:default\",\n          componentPath: componentDefinitionPath,\n          args: { tableName: table },\n        })) as number,\n      }),\n    ),\n  );\n  const deletedIndexesWithDocumentsCount = deletedIndexes.map(\n    ({ componentDefinitionPath, index }) => ({\n      componentDefinitionPath,\n      index,\n      count: documentCounts.find(\n        (count) =>\n          count.table === getTableName(index) &&\n          count.componentDefinitionPath === componentDefinitionPath,\n      )!.count,\n    }),\n  );\n\n  const minDocumentsForWarning = minDocumentsForIndexDeleteWarning();\n  if (\n    !deletedIndexesWithDocumentsCount.some(\n      ({ count }) => count >= minDocumentsForWarning,\n    )\n  ) {\n    logFinishedStep(\"No large indexes are deleted by this push\");\n    return;\n  }\n\n  logMessage(`\u26A0\uFE0F  This code push will ${chalkStderr.bold(\"delete\")} the following ${deletedIndexesWithDocumentsCount.length === 1 ? \"index\" : \"indexes\"}\nfrom your production deployment (${options.url}):\n\n${deletedIndexesWithDocumentsCount\n  .map(({ componentDefinitionPath, index, count }) =>\n    formatDeletedIndex({\n      componentDefinitionPath,\n      index,\n      indexDiff: indexDiffs[componentDefinitionPath],\n      documentsCount: count,\n      minDocumentsForWarning,\n    }),\n  )\n  .join(\"\\n\")}\n\nThe documents that are in the index won\u2019t be deleted, but the index will need\nto be backfilled again if you want to restore it later.\n`);\n\n  if (!askForConfirmation) {\n    logFinishedStep(\n      \"Proceeding with push since --allow-deleting-large-indexes is set\",\n    );\n    return;\n  }\n\n  if (!process.stdin.isTTY) {\n    return ctx.crash({\n      exitCode: 1,\n      errorType: \"fatal\",\n      printedMessage: `To confirm the push:\n\u2022 run the deploy command in an ${chalkStderr.bold(\"interactive terminal\")}\n\u2022 or run the deploy command with the ${chalkStderr.bold(\"--allow-deleting-large-indexes\")} flag`,\n    });\n  }\n\n  stopSpinner();\n  if (\n    !(await promptYesNo(ctx, {\n      message: `Delete ${deletedIndexesWithDocumentsCount.length === 1 ? \"this index\" : \"these indexes\"}?`,\n      default: false,\n    }))\n  ) {\n    return ctx.crash({\n      exitCode: 1,\n      errorType: \"fatal\",\n      printedMessage: `Canceling push`,\n    });\n  }\n\n  logFinishedStep(\"Proceeding with push.\");\n}\n\nfunction formatDeletedIndex({\n  componentDefinitionPath,\n  index,\n  indexDiff,\n  documentsCount,\n  minDocumentsForWarning,\n}: {\n  componentDefinitionPath: string;\n  index: DeveloperIndexConfig;\n  indexDiff: IndexDiff;\n  documentsCount: number;\n  minDocumentsForWarning: number;\n}) {\n  const componentNameFormatted =\n    componentDefinitionPath !== \"\"\n      ? `${chalkStderr.gray(componentDefinitionPath)}:`\n      : \"\";\n\n  const documentsCountFormatted =\n    documentsCount >= minDocumentsForWarning\n      ? `  ${chalkStderr.yellowBright(`\u26A0\uFE0F  ${documentsCount.toLocaleString()} documents`)}`\n      : `  ${documentsCount.toLocaleString()} ${documentsCount === 1 ? \"document\" : \"documents\"}`;\n\n  const replacedBy = indexDiff.added_indexes.find((i) => i.name === index.name);\n  const replacedByFormatted = replacedBy\n    ? `\\n   ${chalkStderr.green(\"\u2192 replaced by:\")} ${formatIndex(replacedBy)}`\n    : \"\";\n\n  return (\n    \"\u26D4 \" +\n    componentNameFormatted +\n    formatIndex(index) +\n    documentsCountFormatted +\n    replacedByFormatted\n  );\n}\n\nfunction getTableName(index: DeveloperIndexConfig) {\n  const [tableName, _indexName] = index.name.split(\".\");\n  return tableName;\n}\n\nfunction minDocumentsForIndexDeleteWarning(): number {\n  const envValue = process.env.CONVEX_MIN_DOCUMENTS_FOR_INDEX_DELETE_WARNING;\n  if (envValue !== undefined) {\n    const parsed = parseInt(envValue, 10);\n    if (!isNaN(parsed)) {\n      return parsed;\n    }\n  }\n  return MIN_DOCUMENTS_FOR_INDEX_DELETE_WARNING;\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAA4B;AAE5B,iBAKO;AACP,qBAA4B;AAC5B,qBAA4B;AAG5B,qBAA6B;AAE7B,iBAA+B;AAE/B,MAAM,yCAAyC;AAE/C,eAAsB,2BAA2B;AAAA,EAC/C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAUkB;AAChB,gCAAc,8DAAyD;AAEvE,QAAM,EAAE,aAAa,IAAI,UAAM,6BAAa,KAAK,MAAM,SAAS,OAAO;AAEvE,QAAM,aAAa,aAAa,cAAc,CAAC;AAC/C,QAAM,iBAAiB,OAAO,QAAQ,UAAU,EAAE;AAAA,IAChD,CAAC,CAAC,yBAAyB,SAAS,MAClC,UAAU,gBAAgB,IAAI,CAAC,WAAW;AAAA,MACxC;AAAA,MACA;AAAA,IACF,EAAE;AAAA,EACN;AAEA,MAAI,eAAe,WAAW,GAAG;AAC/B,oCAAgB,qCAAqC;AACrD;AAAA,EACF;AAEA,QAAM,2BAA2B;AAAA,IAC/B,GAAG,IAAI;AAAA,MACL,eAAe;AAAA,QACb,CAAC,EAAE,yBAAyB,MAAM,MAChC,GAAG,uBAAuB,IAAI,aAAa,KAAK,CAAC;AAAA,MACrD;AAAA,IACF;AAAA,EACF,EAAE,IAAI,CAAC,QAAQ;AACb,UAAM,CAAC,yBAAyB,KAAK,IAAI,IAAI,MAAM,GAAG;AACtD,WAAO,EAAE,yBAAyB,MAAM;AAAA,EAC1C,CAAC;AACD,gCAAc,6DAA6D;AAC3E,QAAM,iBAAiB,MAAM,QAAQ;AAAA,IACnC,yBAAyB;AAAA,MACvB,OAAO,EAAE,yBAAyB,MAAM,OAAO;AAAA,QAC7C;AAAA,QACA;AAAA,QACA,OAAQ,UAAM,2BAAe,KAAK;AAAA,UAChC,eAAe,QAAQ;AAAA,UACvB,UAAU,QAAQ;AAAA,UAClB,cAAc;AAAA,UACd,eAAe;AAAA,UACf,MAAM,EAAE,WAAW,MAAM;AAAA,QAC3B,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EACF;AACA,QAAM,mCAAmC,eAAe;AAAA,IACtD,CAAC,EAAE,yBAAyB,MAAM,OAAO;AAAA,MACvC;AAAA,MACA;AAAA,MACA,OAAO,eAAe;AAAA,QACpB,CAAC,UACC,MAAM,UAAU,aAAa,KAAK,KAClC,MAAM,4BAA4B;AAAA,MACtC,EAAG;AAAA,IACL;AAAA,EACF;AAEA,QAAM,yBAAyB,kCAAkC;AACjE,MACE,CAAC,iCAAiC;AAAA,IAChC,CAAC,EAAE,MAAM,MAAM,SAAS;AAAA,EAC1B,GACA;AACA,oCAAgB,2CAA2C;AAC3D;AAAA,EACF;AAEA,6BAAW,qCAA2B,yBAAY,KAAK,QAAQ,CAAC,kBAAkB,iCAAiC,WAAW,IAAI,UAAU,SAAS;AAAA,mCACpH,QAAQ,GAAG;AAAA;AAAA,EAE5C,iCACC;AAAA,IAAI,CAAC,EAAE,yBAAyB,OAAO,MAAM,MAC5C,mBAAmB;AAAA,MACjB;AAAA,MACA;AAAA,MACA,WAAW,WAAW,uBAAuB;AAAA,MAC7C,gBAAgB;AAAA,MAChB;AAAA,IACF,CAAC;AAAA,EACH,EACC,KAAK,IAAI,CAAC;AAAA;AAAA;AAAA;AAAA,CAIZ;AAEC,MAAI,CAAC,oBAAoB;AACvB;AAAA,MACE;AAAA,IACF;AACA;AAAA,EACF;AAEA,MAAI,CAAC,QAAQ,MAAM,OAAO;AACxB,WAAO,IAAI,MAAM;AAAA,MACf,UAAU;AAAA,MACV,WAAW;AAAA,MACX,gBAAgB;AAAA,sCACW,yBAAY,KAAK,sBAAsB,CAAC;AAAA,4CAClC,yBAAY,KAAK,gCAAgC,CAAC;AAAA,IACrF,CAAC;AAAA,EACH;AAEA,8BAAY;AACZ,MACE,CAAE,UAAM,4BAAY,KAAK;AAAA,IACvB,SAAS,UAAU,iCAAiC,WAAW,IAAI,eAAe,eAAe;AAAA,IACjG,SAAS;AAAA,EACX,CAAC,GACD;AACA,WAAO,IAAI,MAAM;AAAA,MACf,UAAU;AAAA,MACV,WAAW;AAAA,MACX,gBAAgB;AAAA,IAClB,CAAC;AAAA,EACH;AAEA,kCAAgB,uBAAuB;AACzC;AAEA,SAAS,mBAAmB;AAAA,EAC1B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAMG;AACD,QAAM,yBACJ,4BAA4B,KACxB,GAAG,yBAAY,KAAK,uBAAuB,CAAC,MAC5C;AAEN,QAAM,0BACJ,kBAAkB,yBACd,KAAK,yBAAY,aAAa,iBAAO,eAAe,eAAe,CAAC,YAAY,CAAC,KACjF,KAAK,eAAe,eAAe,CAAC,IAAI,mBAAmB,IAAI,aAAa,WAAW;AAE7F,QAAM,aAAa,UAAU,cAAc,KAAK,CAAC,MAAM,EAAE,SAAS,MAAM,IAAI;AAC5E,QAAM,sBAAsB,aACxB;AAAA,KAAQ,yBAAY,MAAM,qBAAgB,CAAC,QAAI,4BAAY,UAAU,CAAC,KACtE;AAEJ,SACE,YACA,6BACA,4BAAY,KAAK,IACjB,0BACA;AAEJ;AAEA,SAAS,aAAa,OAA6B;AACjD,QAAM,CAAC,WAAW,UAAU,IAAI,MAAM,KAAK,MAAM,GAAG;AACpD,SAAO;AACT;AAEA,SAAS,oCAA4C;AACnD,QAAM,WAAW,QAAQ,IAAI;AAC7B,MAAI,aAAa,QAAW;AAC1B,UAAM,SAAS,SAAS,UAAU,EAAE;AACpC,QAAI,CAAC,MAAM,MAAM,GAAG;AAClB,aAAO;AAAA,IACT;AAAA,EACF;AACA,SAAO;AACT;",
  "names": []
}
